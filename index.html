<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="rote/moonsole.js"></script>
		<script src="rote/event-system.js"></script>
		<script src="defensk.c.js"></script>
		<script>
let Defensk = null;
let defensk = null;

DEFENSK().then(async function(instance){
	Defensk = instance;
	defensk = Object.fromEntries([
		[ "create_spline", "number", "number", "number" ],
		[ "spline_free", null, "number" ],
		[ "spline_at", null, "number", "number", "number", "number" ],
		[ "malloc", "number", "number" ],
		[ "free", null, "number" ]
	].map(function([ name, ret, ...args ]){	
		return [ name, Defensk.cwrap(name, ret, args) ]
	}));

	main();
});

const maxY = window.innerHeight;
const maxX = window.innerWidth;

function render(){
	const canvas = document.querySelector("canvas.main");
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	
	const context = canvas.getContext("2d");
	return {
		canvas,
		context
	}
}

class Spline {
	constructor(coords){
		coords = new Float64Array(coords);
		const n = coords.length * coords.BYTES_PER_ELEMENT;
		this.cptr = defensk.malloc(n);
		Defensk.HEAPF64.set(coords, this.cptr >> 3);
		
		this.spline = defensk.create_spline(
			this.cptr,
			coords.length
		);
	}
}

Spline.prototype.at = function(pos){
	const xPtr = defensk.malloc(8);
	const yPtr = defensk.malloc(8);

	defensk.spline_at(this.spline, pos, xPtr, yPtr);

	const x = Defensk.HEAPF64[xPtr >> 3];
	const y = Defensk.HEAPF64[yPtr >> 3];
	
	defensk.free(xPtr);
	defensk.free(yPtr);

	return [ x, y ];
}

Spline.prototype.destroy = function(){
	defensk.free(this.cptr);
	defensk.spline_free(this.spline);
}

class Game extends EventSystem {
	constructor(){
		super();
		const _this = this;
		requestAnimationFrame(function f(){
			_this.emit("frame");

			requestAnimationFrame(f);
		});

		this.missiles = [];
		this.bombs = [];
	}	
}

Game.prototype.launchMissile = function(...param){
	const game = this;
	const missile = new Missile(
		Math.random()*maxX, maxY,
		...param
	);
	missile.destroy = function(){
		this.spline.destroy();
		this.emit("destroy");
		game.missiles.splice(game.missiles.indexOf(this), 1);
	}
	this.missiles.push(missile);
}

Game.prototype.dropBomb = function(x, speed){
	if(x < 0){
		x = Math.random()*maxX;
	}

	const game = this;
	const bomb = new Bomb(
		x, speed
	);

	bomb.destroy = function(){
		this.emit("destroy");
		game.bombs.splice(game.bombs.indexOf(this), 1);
	}
	this.bombs.push(bomb);
}

class Missile extends EventSystem {
	constructor(startX, startY, destX, destY){
		super();

		this.destX = destX;
		this.destY = destY;
		this.points = [];
		this.coords = [
			startX, startY,
			startX, startY,
			((destX - 100) + (Math.random()*200)),
			((destY - 50) + (Math.random()*200)),
			destX, destY
		];
		this.spline = new Spline(this.coords);
		this.progress = 0;
	}
}

Missile.prototype.drawPoints = function(game){
	const { context } = game;
	const points = this.points.slice(-5);
	context.beginPath();
	for(const [ x, y ] of points){
		context.moveTo(x, y);
		context.fillRect(x - 2, y - 2, 1, 1);
		context.lineTo(x, y);
		//console.log(x, y);
	}
	context.stroke();
}

Missile.prototype.draw = function(game){
	const { destX, destY, progress } = this;
	
	this.progress = progress % 100;
	if(this.progress >= 99){
		this.destroy && this.destroy();
		this.drawPoints(game);
		this.explode(game);
		return ;
	}
	
	this.points.push(this.spline.at(this.progress/100));
	this.drawPoints(game);
}

Missile.prototype.explode = function(game){
	const radius = 60;
	const x = this.destX;
	const y = this.destY;
	game.context.arc(x, y, radius, 0, 2 * Math.PI);
	game.context.stroke();

	for(const bomb of game.bombs){
		if(bomb.x < (x - radius))
			continue ;
			
		if(bomb.x > (x + radius))
			continue ;
			
		if(bomb.y > (y + radius))
			continue ;
			
		if(bomb.y < (y - radius))
			continue ;

		//game.bombs.splice(game.bombs.indexOf(bomb), 1);
		bomb.destroy();
	}
}

class Bomb extends EventSystem {
	constructor(x, speed){
		super();
		if(x < 0)
			x = Math.random()*maxX;

		this.progress = 0;
		this.speed = (speed || (1 + Math.random()))/20;
		this.x = x;
	}
}

Object.defineProperties(Bomb.prototype, {
	y: {
		get(){
			return (this.progress/100)*maxY;
		}
	}
})

Bomb.prototype.draw = function(game){
	this.progress = this.progress % 100;
	const y = (this.progress/100)*maxY;
	game.context.fillRect(this.x - 1, y, 3, 3);
	game.context.fillRect(this.x, y - 12, 1, 9);
}

const game = new Game();
let last = 0;
game.on("frame", function(){
	if(!this.context)
		return ;

	this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
	for(const missile of this.missiles){
		missile.progress += 1;
		missile.draw(this);
	}

	for(const bomb of this.bombs){
		bomb.progress += bomb.speed;
		bomb.draw(this);
	}

	const now = Date.now();
	if((last + (1000/12)) < now){
		game.emit("fps12");
		
		last = now;
	}
});

game.on("fps12", function(){
	for(const missile of this.missiles){

	}

	for(const bomb of this.bombs){

	}

	if((Math.random() * 500) > 400)
		game.dropBomb(-1, 8);	
});

async function main(){
	if(document.readyState == "loading"){
		return window.addEventListener("DOMContentLoaded", main);
	}

	Object.assign(game, render());

	let pos = 0;
	let clientX = 30;
	let clientY = 30;
	const { context } = render();
	
	window.addEventListener("click", function(click){
		clientX = click.clientX;
		clientY = click.clientY;

		game.launchMissile(clientX, clientY);
	});
}
		</script>
	</head>
	<body>
		<canvas class="main"></canvas>
	</body>
</html>
